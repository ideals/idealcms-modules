<?phpnamespace Cabinet\Structure\Registration\Site;use Ideal\Core\Config;use Ideal\Core\Db;class AjaxController extends \Ideal\Core\Site\AjaxController{    public function loginAction()    {        session_start();        if($_SESSION['login']['input']) return;        $email = @ htmlspecialchars($_POST['email']);        $pass = @ htmlspecialchars($_POST['pass']);        $db = Db::getInstance();        $config = Config::getInstance();        $table = $config->db['prefix'] . 'cabinet_structure_registration';        $tmp = $db->queryArray("SELECT ID,password,last_visit FROM {$table} WHERE email='{$email}' LIMIT 1");        $pass = crypt($pass, $tmp[0]['password']);        if ($pass === $tmp[0]['password']) {            $_SESSION['login']['user'] = $email;            $_SESSION['login']['input'] = true;            print 'Вы успешно вошли';            return;        } else {            print 'Вы не правильно указали email или пароль';        }    }    public function registrationAction()    {        session_start();        $errStr = '';        $fio = @ htmlspecialchars($_POST['fio']);        $phone = @ htmlspecialchars($_POST['phone']);        $email = @ htmlspecialchars($_POST['email']);        $pass = @ htmlspecialchars($_POST['pass']);        // Check e-mail        if (!filter_var($_POST['email'], FILTER_VALIDATE_EMAIL)) {            $errStr .= "Не верный E-mail";        }        // Check captcha        $c = $_POST['captcha'];        $c = md5($c);        if ($c != $_SESSION['cryptcode']) {            $errStr .= "Не верная captcha";        }        if ($errStr != '') {            print $errStr;            return;        }        $db = Db::getInstance();        $config = Config::getInstance();        $table = $config->db['prefix'] . 'cabinet_structure_registration';        $tmp = $db->queryArray("SELECT ID FROM {$table} WHERE email='{$_POST['email']}' LIMIT 1");        if (count($tmp) > 0) {            print 'Такой Email зарегестрирован';            return;        }        $structure_path = $config->getStructureByName('Cabinet_Registration');        $structure_path = $structure_path['ID'];        $key = md5(time());        $db->insert($config->db['prefix'] . 'cabinet_structure_registration', array(            'email' => $_POST['email'],            'password' => $_POST['pass'],            'is_active' => 0,            'structure_path' => $structure_path,            'act_key' => $key,            'reg_date' => time()        ));        $message = <<<EOTДля продолжение регистрации перейдите по ссылке http://{$config->domain}/cabinet.html?email=$email&key=$keyИмя: $fioТелефон: $phoneEmail: $emailPassword: $passEOT;        $title = 'Регистрация';        $to = 'help@neox.ru';        $headers = "From: {$config->robotEmail}\r\n"            . "Bcc: help1@neox.ru\r\n"            . "Content-type: text/plain; charset=\"utf-8\"";        if (mail($to, $title, $message, $headers)) {            print 'Вам было отправлено письмо с инструкцией для дальнейшей регистрации';        } else {            print 'Ошибка. Попробуйте чуть позже';        }    }}