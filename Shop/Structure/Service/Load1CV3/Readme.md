# Описание процесса обмена данными с 1С
В общем виде процесс можно определить как последовательную отправку запросов от 1С к сайту. 
Запросы состоят из следующих частей:
 * type - тип запроса ("catalog" или "sale"), обмен информацией по товарам или заказам соответственно
 * mode - какое именно действие необходимо выполнить. Каждому значению из этого параметра должен соответствовать свой 
 метод во фронт контроллере.
 * filename - имя передаваемого/обрабатываемого файла
 
> Первые две части присутствуют во всех запросах, последняя только в запросах связанных с получением/обработкой файлов. 
###Получение информации о товарах
  ####Начало сеанса
  
  Сеанс получения данных о товарах начинается с запроса от 1С, который выглядит так 
  "http[s]://<сайт>/<путь до админки>/Mods/Shop/Structure/Service/Load1CV3/1c_exchange.php?type=catalog&mode=checkauth".
  
  На этом этапе происходит HTTP-аутентификация, а значит доступны значения в $_SERVER['PHP_AUTH_USER'] и 
  $_SERVER['PHP_AUTH_PW'] (логин и пароль соответственно). По этим данным происходит стандартная (в рамках Iedal CMS) аутентификация пользователя, как если бы пользователь 
  вводил эти данные при входе в админку. 
  
  Ответ должен содержать несколько строк (используется разделитель "\n") :
  1. "success" или "failure" - признак (не)успешной аутентификации. Последующие строки важны только в случае успешной 
  аутентификации. Если аутентификация не пройдена, то следующие строки содержат соответствующее сообщение. 
  2. Имя куки = session_name()
  3. Значение куки = session_id()
  4. Ключ сессии обмена (CSRF) (`Пока не реализовано, работает без этого`)
  5. Дата и время сервера сайта (CSRF) (`Пока не реализовано, работает без этого`)
  
  ####Запрос параметров от сайта
  
  Запрос вида
  "http[s]://<сайт>/<путь до админки>/Mods/Shop/Structure/Service/Load1CV3/1c_exchange.php?type=catalog&mode=init".
  
  Ответ должен содержать несколько строк (используется разделитель "\n") :
  1. Разрешен ли Zip (zip=yes|no) 
  2. Информация об ограничении файлов по размеру (file_limit=значение в байтах)
  3. Ключ сессии обмена (`Пока не реализовано, работает без этого`)
  4. Версия CommerceML (schema_version = 2.08)
    
  > Шаги "Начало сеанса" и "Запрос параметров от сайта" повторяются перед передачей каждого файла.
  В случае, если передаются картинки, то первые два шага повторяются только один раз перед передачей файла import_*.xml
  
  #### Пошаговая загрузка данных
  В общем виде процесс получения данных от 1С выглядит следующим образом:
  1. Передаваемый файл сохраняется в папке на сервере.
  2. Обработка переданного файла. Поиск нужного файла для обработки производится в папке куда загружаются все файлы.
     Если в папке присутствует архив, то на этом этапе он будет распакован. 
  3. Удаление переданного файла. Перед удалением, в зависимости от настроек, файл может быть перемещён в другую папку
  для сохранения наглядного представления полученных данных от 1С.
  
  Для передачи файла на сервер 1С посылает запрос вида "1c_exchange.php?type=catalog&mode=file&filename=<имя файла>".
  Ответ должен содержать одну строку "success" или "failure" (файл сохранён/не сохранён)
  
  Затем приходит запрос на обработку переданного файла "1c_exchange.php?type=catalog&mode=import&filename=<имя файла>".
  Ответ может иметь один из следующих видов:
   * progress - файл обрабатывается (на следующей строке ответа указано на каком этапе) 
   `Пока этот вариант не реализован и не используется`
   * success - файл успешно обработан
   * failure - файл не обработан. На последующих строках объяснение причины возникновения ошибки.
   
  > если сервер отдаст пустое сообщение (или 1С не дождётся ответа вовсе), то файл также будет считаться не обработанным
  и будет заново послан запрос на его обработку
     
  На данный момент корректно обрабатывается следующий порядок предоставления файлов:
  1. Файл с общей информацией о структуре каталога (import_*.xml). В момент обработки этого файла происходит инициация 
  начала нового сеанса обмена данными (создаются актуальные временные таблицы, подготавливается каталог для приёма 
  файлов)
  2. Файл с общей информацией по справочникам (offers_*.xml)
  3. Файл с информацией по товарм (import_*.xml). За этим файлом может следовать ряд запросов для передачи картинок и 
  только после того как будут переданы все картинки будет отправлен запрос на обработку этого файла. Во время обработки 
  этого файла так же происходит обработка картинок (если они были переданы). Если обмен происходит с возможностью 
  получения архивов, то архив будет содержать сам файл импорта и все картинки.
  4. Файл с информацией по товарным предложениям (offers_*.xml)
  5. Файл с информацией по ценам на товары и предложения (prices_*.xml)
  6. Файл с информацией по старым ценам на товары и предложения (pricesold_*.xml)
  7. Файл с информацией по остаткам на складе для товаров и предложений (rests_*.xml)
     
     `Далее перечислены файлы, специфичные для donjon.ru. В других проектах могут быть другие файлы. По названиям файлов 
     в Ideal CMS инициируется соответствующий класс, который занимается обработкой этих файлов.`

  8. Файл с информацией об основном изображении для товара (ImagesFile_*.xml)
  9. Файл с информацией о тегах для каждого товара(Tegi_*.xml)
  10. Файл с информацией о совместно продаваемых товарах (NomenclProSov_*.xml)
  11. Файл с отчётом о выгрузке от 1С (\Reports\Exchange_*.zip). Этот файл присылается только для сохранения, запроса на 
  его обработку не приходит. Передача этого файла является тригером для инициации процесса завершения обмена данными 
  (подмены временных таблиц на боевые)
  
  > Запросы на получение/обработку файлов 3-10 могут поступать циклически (но это должны быть всегда разные файлы).
  Это связано с тем что данные в выгрузке могут быть разбиты на пакеты.
  В свою очередь файлы 1,2,11 всегда приходят в единичном экземпляре.
  
  > Если происходит полная выгрузка товаров то в конце обмена приходит запрос на деактивацию
  "type=catalog&mode=deactivate". На данный момент этот запрос никак не обрабатывается за ненадобностью.
  
